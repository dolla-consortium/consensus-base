<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DuplicateRecordFields #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE Rank2Types #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Dolla.Consensus.Consortium.Projections</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Location"><span class="hs-identifier">Location</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ActiveNodeIds"><span class="hs-identifier">ActiveNodeIds</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#toActiveNodeIds"><span class="hs-identifier">toActiveNodeIds</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#NodeIdsForBlock"><span class="hs-identifier">NodeIdsForBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#mapToNodeIdList"><span class="hs-identifier">mapToNodeIdList</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier">ConsortiumState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#MembershipStatus"><span class="hs-identifier">MembershipStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#LocationStatus"><span class="hs-identifier">LocationStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#toConsortiumState%27"><span class="hs-identifier">toConsortiumState'</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#initialConsortiumState"><span class="hs-identifier">initialConsortiumState</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">log</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html"><span class="hs-identifier">Dolla.Consensus.Consortium.Event</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Dolla.Common.Offset</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Dolla.Common.NodeId</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.IntMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IM</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Dolla.Common.Network.Core</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Dolla.Common.Memory.Byte</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Byte</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Dolla.Common.Logging.Core</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Strict</span></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Streamly</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Streamly.Internal.Prelude</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SIP</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Dolla.Common.Verification</span></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-comment">-- Active Team : Team not revoked and having a location provided</span><span>
</span><span id="line-41"></span><span class="hs-keyword">data</span><span> </span><span id="Location"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Location"><span class="hs-identifier hs-var">Location</span></a></span></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Location"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Location"><span class="hs-identifier hs-var">Location</span></a></span></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AstatusServerUrl%3ALocation"><span class="annot"><span class="annottext">Location -&gt; URL
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AstatusServerUrl%3ALocation"><span class="hs-identifier hs-var hs-var">statusServerUrl</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">URL</span></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AdownloadServerUrl%3ALocation"><span class="annot"><span class="annottext">Location -&gt; URL
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AdownloadServerUrl%3ALocation"><span class="hs-identifier hs-var hs-var">downloadServerUrl</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">URL</span></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AvotingBroadcastUrl%3ALocation"><span class="annot"><span class="annottext">Location -&gt; URL
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AvotingBroadcastUrl%3ALocation"><span class="hs-identifier hs-var hs-var">votingBroadcastUrl</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">URL</span></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AreceptionistUrl%3ALocation"><span class="annot"><span class="annottext">Location -&gt; URL
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AreceptionistUrl%3ALocation"><span class="hs-identifier hs-var hs-var">receptionistUrl</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">URL</span></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679408203"><span id="local-6989586621679408205"><span class="annot"><span class="annottext">Location -&gt; Location -&gt; Bool
(Location -&gt; Location -&gt; Bool)
-&gt; (Location -&gt; Location -&gt; Bool) -&gt; Eq Location
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Location -&gt; Location -&gt; Bool
$c/= :: Location -&gt; Location -&gt; Bool
== :: Location -&gt; Location -&gt; Bool
$c== :: Location -&gt; Location -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679408196"><span id="local-6989586621679408198"><span id="local-6989586621679408200"><span class="annot"><span class="annottext">Int -&gt; Location -&gt; ShowS
[Location] -&gt; ShowS
Location -&gt; String
(Int -&gt; Location -&gt; ShowS)
-&gt; (Location -&gt; String) -&gt; ([Location] -&gt; ShowS) -&gt; Show Location
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Location] -&gt; ShowS
$cshowList :: [Location] -&gt; ShowS
show :: Location -&gt; String
$cshow :: Location -&gt; String
showsPrec :: Int -&gt; Location -&gt; ShowS
$cshowsPrec :: Int -&gt; Location -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">data</span><span> </span><span id="ActiveNodeIds"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ActiveNodeIds"><span class="hs-identifier hs-var">ActiveNodeIds</span></a></span></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ActiveNodeIds"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ActiveNodeIds"><span class="hs-identifier hs-var">ActiveNodeIds</span></a></span></span><span>
</span><span id="line-51"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AblockInProgress%3AActiveNodeIds"><span class="annot"><span class="annottext">ActiveNodeIds -&gt; Offset
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AblockInProgress%3AActiveNodeIds"><span class="hs-identifier hs-var hs-var">blockInProgress</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Offset</span></span><span>
</span><span id="line-52"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Alocations%3AActiveNodeIds"><span class="annot"><span class="annottext">ActiveNodeIds -&gt; [(NodeId, Location)]
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3Alocations%3AActiveNodeIds"><span class="hs-identifier hs-var hs-var">locations</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NodeId</span></span><span class="hs-special">,</span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Location"><span class="hs-identifier hs-type">Location</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-53"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679408186"><span id="local-6989586621679408188"><span id="local-6989586621679408190"><span class="annot"><span class="annottext">Int -&gt; ActiveNodeIds -&gt; ShowS
[ActiveNodeIds] -&gt; ShowS
ActiveNodeIds -&gt; String
(Int -&gt; ActiveNodeIds -&gt; ShowS)
-&gt; (ActiveNodeIds -&gt; String)
-&gt; ([ActiveNodeIds] -&gt; ShowS)
-&gt; Show ActiveNodeIds
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ActiveNodeIds] -&gt; ShowS
$cshowList :: [ActiveNodeIds] -&gt; ShowS
show :: ActiveNodeIds -&gt; String
$cshow :: ActiveNodeIds -&gt; String
showsPrec :: Int -&gt; ActiveNodeIds -&gt; ShowS
$cshowsPrec :: Int -&gt; ActiveNodeIds -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">data</span><span> </span><span id="NodeIdsForBlock"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#NodeIdsForBlock"><span class="hs-identifier hs-var">NodeIdsForBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NodeIdsForBlock"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#NodeIdsForBlock"><span class="hs-identifier hs-var">NodeIdsForBlock</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AblockInProgress%3ANodeIdsForBlock"><span class="annot"><span class="annottext">NodeIdsForBlock -&gt; Offset
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AblockInProgress%3ANodeIdsForBlock"><span class="hs-identifier hs-var hs-var">blockInProgress</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Offset</span></span><span class="hs-special">,</span><span> </span><span id="%24sel%3AnodeIds%3ANodeIdsForBlock"><span class="annot"><span class="annottext">NodeIdsForBlock -&gt; [NodeId]
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeIds%3ANodeIdsForBlock"><span class="hs-identifier hs-var hs-var">nodeIds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">NodeId</span></span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679408177"><span id="local-6989586621679408179"><span id="local-6989586621679408181"><span class="annot"><span class="annottext">Int -&gt; NodeIdsForBlock -&gt; ShowS
[NodeIdsForBlock] -&gt; ShowS
NodeIdsForBlock -&gt; String
(Int -&gt; NodeIdsForBlock -&gt; ShowS)
-&gt; (NodeIdsForBlock -&gt; String)
-&gt; ([NodeIdsForBlock] -&gt; ShowS)
-&gt; Show NodeIdsForBlock
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [NodeIdsForBlock] -&gt; ShowS
$cshowList :: [NodeIdsForBlock] -&gt; ShowS
show :: NodeIdsForBlock -&gt; String
$cshow :: NodeIdsForBlock -&gt; String
showsPrec :: Int -&gt; NodeIdsForBlock -&gt; ShowS
$cshowsPrec :: Int -&gt; NodeIdsForBlock -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">data</span><span> </span><span id="MembershipStatus"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#MembershipStatus"><span class="hs-identifier hs-var">MembershipStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Granted"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Granted"><span class="hs-identifier hs-var">Granted</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Revoked"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Revoked"><span class="hs-identifier hs-var">Revoked</span></a></span></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679408171"><span id="local-6989586621679408173"><span class="annot"><span class="annottext">MembershipStatus -&gt; MembershipStatus -&gt; Bool
(MembershipStatus -&gt; MembershipStatus -&gt; Bool)
-&gt; (MembershipStatus -&gt; MembershipStatus -&gt; Bool)
-&gt; Eq MembershipStatus
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: MembershipStatus -&gt; MembershipStatus -&gt; Bool
$c/= :: MembershipStatus -&gt; MembershipStatus -&gt; Bool
== :: MembershipStatus -&gt; MembershipStatus -&gt; Bool
$c== :: MembershipStatus -&gt; MembershipStatus -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679408165"><span id="local-6989586621679408167"><span id="local-6989586621679408169"><span class="annot"><span class="annottext">Int -&gt; MembershipStatus -&gt; ShowS
[MembershipStatus] -&gt; ShowS
MembershipStatus -&gt; String
(Int -&gt; MembershipStatus -&gt; ShowS)
-&gt; (MembershipStatus -&gt; String)
-&gt; ([MembershipStatus] -&gt; ShowS)
-&gt; Show MembershipStatus
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MembershipStatus] -&gt; ShowS
$cshowList :: [MembershipStatus] -&gt; ShowS
show :: MembershipStatus -&gt; String
$cshow :: MembershipStatus -&gt; String
showsPrec :: Int -&gt; MembershipStatus -&gt; ShowS
$cshowsPrec :: Int -&gt; MembershipStatus -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">data</span><span> </span><span id="LocationStatus"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#LocationStatus"><span class="hs-identifier hs-var">LocationStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NoLocation"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#NoLocation"><span class="hs-identifier hs-var">NoLocation</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Located"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Located"><span class="hs-identifier hs-var">Located</span></a></span></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Location"><span class="hs-identifier hs-type">Location</span></a></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679408159"><span id="local-6989586621679408161"><span class="annot"><span class="annottext">LocationStatus -&gt; LocationStatus -&gt; Bool
(LocationStatus -&gt; LocationStatus -&gt; Bool)
-&gt; (LocationStatus -&gt; LocationStatus -&gt; Bool) -&gt; Eq LocationStatus
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: LocationStatus -&gt; LocationStatus -&gt; Bool
$c/= :: LocationStatus -&gt; LocationStatus -&gt; Bool
== :: LocationStatus -&gt; LocationStatus -&gt; Bool
$c== :: LocationStatus -&gt; LocationStatus -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679408153"><span id="local-6989586621679408155"><span id="local-6989586621679408157"><span class="annot"><span class="annottext">Int -&gt; LocationStatus -&gt; ShowS
[LocationStatus] -&gt; ShowS
LocationStatus -&gt; String
(Int -&gt; LocationStatus -&gt; ShowS)
-&gt; (LocationStatus -&gt; String)
-&gt; ([LocationStatus] -&gt; ShowS)
-&gt; Show LocationStatus
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [LocationStatus] -&gt; ShowS
$cshowList :: [LocationStatus] -&gt; ShowS
show :: LocationStatus -&gt; String
$cshow :: LocationStatus -&gt; String
showsPrec :: Int -&gt; LocationStatus -&gt; ShowS
$cshowsPrec :: Int -&gt; LocationStatus -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">data</span><span> </span><span id="ConsortiumState"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-var">ConsortiumState</span></a></span></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ConsortiumState"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-var">ConsortiumState</span></a></span></span><span>
</span><span id="line-62"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AblockCreated%3AConsortiumState"><span class="annot"><span class="annottext">ConsortiumState -&gt; Offset
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AblockCreated%3AConsortiumState"><span class="hs-identifier hs-var hs-var">blockCreated</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Offset</span></span><span>
</span><span id="line-63"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AnodeIndexes%3AConsortiumState"><span class="annot"><span class="annottext">ConsortiumState -&gt; HashMap NodeId Int
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeIndexes%3AConsortiumState"><span class="hs-identifier hs-var hs-var">nodeIndexes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- counting disabled ones</span><span>
</span><span id="line-64"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AproposalSizeLimitMaybe%3AConsortiumState"><span class="annot"><span class="annottext">ConsortiumState -&gt; Maybe Byte
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AproposalSizeLimitMaybe%3AConsortiumState"><span class="hs-identifier hs-var hs-var">proposalSizeLimitMaybe</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Byte</span></span><span>
</span><span id="line-65"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AnodeStates%3AConsortiumState"><span class="annot"><span class="annottext">ConsortiumState
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeStates%3AConsortiumState"><span class="hs-identifier hs-var hs-var">nodeStates</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IM.IntMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NodeId</span></span><span class="hs-special">,</span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#MembershipStatus"><span class="hs-identifier hs-type">MembershipStatus</span></a></span><span class="hs-special">,</span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#LocationStatus"><span class="hs-identifier hs-type">LocationStatus</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679408142"><span id="local-6989586621679408144"><span id="local-6989586621679408146"><span class="annot"><span class="annottext">Int -&gt; ConsortiumState -&gt; ShowS
[ConsortiumState] -&gt; ShowS
ConsortiumState -&gt; String
(Int -&gt; ConsortiumState -&gt; ShowS)
-&gt; (ConsortiumState -&gt; String)
-&gt; ([ConsortiumState] -&gt; ShowS)
-&gt; Show ConsortiumState
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ConsortiumState] -&gt; ShowS
$cshowList :: [ConsortiumState] -&gt; ShowS
show :: ConsortiumState -&gt; String
$cshow :: ConsortiumState -&gt; String
showsPrec :: Int -&gt; ConsortiumState -&gt; ShowS
$cshowsPrec :: Int -&gt; ConsortiumState -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span id="local-6989586621679408250"><span id="local-6989586621679408251"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#toNodeIdList"><span class="hs-identifier hs-type">toNodeIdList</span></a></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679408251"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621679408250"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679408251"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679408250"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Logger</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408251"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408251"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#NodeIdsForBlock"><span class="hs-identifier hs-type">NodeIdsForBlock</span></a></span></span></span><span>
</span><span id="line-73"></span><span id="toNodeIdList"><span class="annot"><span class="annottext">toNodeIdList :: ConsortiumState
-&gt; (r -&gt; (Logger, NodeId))
-&gt; SerialT m Event
-&gt; SerialT m NodeIdsForBlock
</span><a href="Dolla.Consensus.Consortium.Projections.html#toNodeIdList"><span class="hs-identifier hs-var hs-var">toNodeIdList</span></a></span></span><span> </span><span id="local-6989586621679408140"><span class="annot"><span class="annottext">initialState :: ConsortiumState
</span><a href="#local-6989586621679408140"><span class="hs-identifier hs-var">initialState</span></a></span></span><span> </span><span id="local-6989586621679408139"><span class="annot"><span class="annottext">trans :: r -&gt; (Logger, NodeId)
</span><a href="#local-6989586621679408139"><span class="hs-identifier hs-var">trans</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsortiumState
-&gt; SerialT (StateT ConsortiumState m) NodeIdsForBlock
-&gt; SerialT m NodeIdsForBlock
forall (m :: * -&gt; *) s a.
Monad m =&gt;
s -&gt; SerialT (StateT s m) a -&gt; SerialT m a
</span><span class="hs-identifier hs-var">SIP.evalStateT</span></span><span> </span><span class="annot"><span class="annottext">ConsortiumState
</span><a href="#local-6989586621679408140"><span class="hs-identifier hs-var">initialState</span></a></span><span> </span><span class="annot"><span class="annottext">(SerialT (StateT ConsortiumState m) NodeIdsForBlock
 -&gt; SerialT m NodeIdsForBlock)
-&gt; (SerialT m Event
    -&gt; SerialT (StateT ConsortiumState m) NodeIdsForBlock)
-&gt; SerialT m Event
-&gt; SerialT m NodeIdsForBlock
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(r -&gt; (Logger, NodeId))
-&gt; SerialT (StateT ConsortiumState m) Event
-&gt; SerialT (StateT ConsortiumState m) NodeIdsForBlock
forall (m :: * -&gt; *) r.
(MonadIO m, MonadReader r m, MonadState ConsortiumState m) =&gt;
(r -&gt; (Logger, NodeId))
-&gt; SerialT m Event -&gt; SerialT m NodeIdsForBlock
</span><a href="Dolla.Consensus.Consortium.Projections.html#toNodeIdList%27"><span class="hs-identifier hs-var">toNodeIdList'</span></a></span><span> </span><span class="annot"><span class="annottext">r -&gt; (Logger, NodeId)
</span><a href="#local-6989586621679408139"><span class="hs-identifier hs-var">trans</span></a></span><span> </span><span class="annot"><span class="annottext">(SerialT (StateT ConsortiumState m) Event
 -&gt; SerialT (StateT ConsortiumState m) NodeIdsForBlock)
-&gt; (SerialT m Event -&gt; SerialT (StateT ConsortiumState m) Event)
-&gt; SerialT m Event
-&gt; SerialT (StateT ConsortiumState m) NodeIdsForBlock
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SerialT m Event -&gt; SerialT (StateT ConsortiumState m) Event
forall (m :: * -&gt; *) (t :: (* -&gt; *) -&gt; * -&gt; *)
       (tr :: (* -&gt; *) -&gt; * -&gt; *) a.
(Monad m, IsStream t, MonadTrans tr, Monad (tr m)) =&gt;
t m a -&gt; t (tr m) a
</span><span class="hs-identifier hs-var">SIP.liftInner</span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span id="local-6989586621679408287"><span id="local-6989586621679408289"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#toNodeIdList%27"><span class="hs-identifier hs-type">toNodeIdList'</span></a></span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679408289"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-77"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621679408287"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679408289"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-78"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679408289"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679408287"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Logger</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408289"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408289"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#NodeIdsForBlock"><span class="hs-identifier hs-type">NodeIdsForBlock</span></a></span></span></span><span>
</span><span id="line-82"></span><span id="toNodeIdList%27"><span class="annot"><span class="annottext">toNodeIdList' :: (r -&gt; (Logger, NodeId))
-&gt; SerialT m Event -&gt; SerialT m NodeIdsForBlock
</span><a href="Dolla.Consensus.Consortium.Projections.html#toNodeIdList%27"><span class="hs-identifier hs-var hs-var">toNodeIdList'</span></a></span></span><span> </span><span id="local-6989586621679408134"><span class="annot"><span class="annottext">trans :: r -&gt; (Logger, NodeId)
</span><a href="#local-6989586621679408134"><span class="hs-identifier hs-var">trans</span></a></span></span><span> </span><span id="local-6989586621679408133"><span class="annot"><span class="annottext">events :: SerialT m Event
</span><a href="#local-6989586621679408133"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ActiveNodeIds"><span class="hs-identifier hs-type">ActiveNodeIds</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679408132"><span class="annot"><span class="annottext">Offset
blockInProgress :: Offset
$sel:blockInProgress:ActiveNodeIds :: ActiveNodeIds -&gt; Offset
</span><a href="#local-6989586621679408132"><span class="hs-identifier hs-var hs-var">blockInProgress</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679408131"><span class="annot"><span class="annottext">[(NodeId, Location)]
locations :: [(NodeId, Location)]
$sel:locations:ActiveNodeIds :: ActiveNodeIds -&gt; [(NodeId, Location)]
</span><a href="#local-6989586621679408131"><span class="hs-identifier hs-var hs-var">locations</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(r -&gt; (Logger, NodeId))
-&gt; SerialT m Event -&gt; SerialT m ActiveNodeIds
forall (m :: * -&gt; *) r.
(MonadIO m, MonadReader r m, MonadState ConsortiumState m) =&gt;
(r -&gt; (Logger, NodeId))
-&gt; SerialT m Event -&gt; SerialT m ActiveNodeIds
</span><a href="Dolla.Consensus.Consortium.Projections.html#toActiveNodeIds"><span class="hs-identifier hs-var">toActiveNodeIds</span></a></span><span> </span><span class="annot"><span class="annottext">r -&gt; (Logger, NodeId)
</span><a href="#local-6989586621679408134"><span class="hs-identifier hs-var">trans</span></a></span><span> </span><span class="annot"><span class="annottext">SerialT m Event
</span><a href="#local-6989586621679408133"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><span class="annottext">NodeIdsForBlock -&gt; SerialT m NodeIdsForBlock
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">NodeIdsForBlock :: Offset -&gt; [NodeId] -&gt; NodeIdsForBlock
</span><a href="Dolla.Consensus.Consortium.Projections.html#NodeIdsForBlock"><span class="hs-identifier hs-type hs-type">NodeIdsForBlock</span></a></span><span> </span><span>
</span><span id="line-85"></span><span>         </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:nodeIds:NodeIdsForBlock :: [NodeId]
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeIds%3ANodeIdsForBlock"><span class="hs-identifier hs-var">nodeIds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NodeId, Location) -&gt; NodeId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((NodeId, Location) -&gt; NodeId) -&gt; [(NodeId, Location)] -&gt; [NodeId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(NodeId, Location)]
</span><a href="#local-6989586621679408131"><span class="hs-identifier hs-var">locations</span></a></span><span>
</span><span id="line-86"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Offset
blockInProgress :: Offset
$sel:blockInProgress:NodeIdsForBlock :: Offset
</span><a href="#local-6989586621679408132"><span class="hs-identifier hs-var hs-var">blockInProgress</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span id="local-6989586621679408275"><span id="local-6989586621679408276"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#toActiveNodeIds"><span class="hs-identifier hs-type">toActiveNodeIds</span></a></span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679408276"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-91"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621679408275"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679408276"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-92"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679408276"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679408275"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Logger</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408276"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408276"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ActiveNodeIds"><span class="hs-identifier hs-type">ActiveNodeIds</span></a></span></span></span><span>
</span><span id="line-96"></span><span id="toActiveNodeIds"><span class="annot"><span class="annottext">toActiveNodeIds :: (r -&gt; (Logger, NodeId))
-&gt; SerialT m Event -&gt; SerialT m ActiveNodeIds
</span><a href="Dolla.Consensus.Consortium.Projections.html#toActiveNodeIds"><span class="hs-identifier hs-var hs-var">toActiveNodeIds</span></a></span></span><span> </span><span id="local-6989586621679408128"><span class="annot"><span class="annottext">trans :: r -&gt; (Logger, NodeId)
</span><a href="#local-6989586621679408128"><span class="hs-identifier hs-var">trans</span></a></span></span><span> </span><span id="local-6989586621679408127"><span class="annot"><span class="annottext">events :: SerialT m Event
</span><a href="#local-6989586621679408127"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679408126"><span class="annot"><span class="annottext">Offset
blockCreated :: Offset
$sel:blockCreated:ConsortiumState :: ConsortiumState -&gt; Offset
</span><a href="#local-6989586621679408126"><span class="hs-identifier hs-var hs-var">blockCreated</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679408125"><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
nodeStates :: IntMap (NodeId, MembershipStatus, LocationStatus)
$sel:nodeStates:ConsortiumState :: ConsortiumState
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408125"><span class="hs-identifier hs-var hs-var">nodeStates</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(r -&gt; (Logger, NodeId))
-&gt; SerialT m Event -&gt; SerialT m ConsortiumState
forall (m :: * -&gt; *) r.
(MonadIO m, MonadReader r m, MonadState ConsortiumState m) =&gt;
(r -&gt; (Logger, NodeId))
-&gt; SerialT m Event -&gt; SerialT m ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#toConsortiumState%27"><span class="hs-identifier hs-var">toConsortiumState'</span></a></span><span> </span><span class="annot"><span class="annottext">r -&gt; (Logger, NodeId)
</span><a href="#local-6989586621679408128"><span class="hs-identifier hs-var">trans</span></a></span><span> </span><span class="annot"><span class="annottext">SerialT m Event
</span><a href="#local-6989586621679408127"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679408124"><span class="annot"><span class="annottext">locations :: [(NodeId, Location)]
</span><a href="#local-6989586621679408124"><span class="hs-identifier hs-var hs-var">locations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-99"></span><span>        </span><span class="annot"><span class="annottext">IntMap (NodeId, Location) -&gt; [(NodeId, Location)]
forall a. IntMap a -&gt; [a]
</span><span class="hs-identifier hs-var">IM.elems</span></span><span> </span><span class="annot"><span class="annottext">(IntMap (NodeId, Location) -&gt; [(NodeId, Location)])
-&gt; IntMap (NodeId, Location) -&gt; [(NodeId, Location)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">((NodeId, MembershipStatus, LocationStatus)
 -&gt; Maybe (NodeId, Location))
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; IntMap (NodeId, Location)
forall a b. (a -&gt; Maybe b) -&gt; IntMap a -&gt; IntMap b
</span><span class="hs-identifier hs-var">IM.mapMaybe</span></span><span>
</span><span id="line-101"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-102"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621679408121"><span class="annot"><span class="annottext">nodeId :: NodeId
</span><a href="#local-6989586621679408121"><span class="hs-identifier hs-var">nodeId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Granted"><span class="hs-identifier hs-type">Granted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#Located"><span class="hs-identifier hs-type">Located</span></a></span><span> </span><span id="local-6989586621679408120"><span class="annot"><span class="annottext">url :: Location
</span><a href="#local-6989586621679408120"><span class="hs-identifier hs-var">url</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(NodeId, Location) -&gt; Maybe (NodeId, Location)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679408121"><span class="hs-identifier hs-var">nodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Location
</span><a href="#local-6989586621679408120"><span class="hs-identifier hs-var">url</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (NodeId, Location)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>          </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408125"><span class="hs-identifier hs-var">nodeStates</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="annot"><span class="annottext">ActiveNodeIds -&gt; SerialT m ActiveNodeIds
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ActiveNodeIds :: Offset -&gt; [(NodeId, Location)] -&gt; ActiveNodeIds
</span><a href="Dolla.Consensus.Consortium.Projections.html#ActiveNodeIds"><span class="hs-identifier hs-type hs-type">ActiveNodeIds</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">[(NodeId, Location)]
locations :: [(NodeId, Location)]
$sel:locations:ActiveNodeIds :: [(NodeId, Location)]
</span><a href="#local-6989586621679408124"><span class="hs-identifier hs-var hs-var">locations</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:blockInProgress:ActiveNodeIds :: Offset
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AblockInProgress%3AActiveNodeIds"><span class="hs-identifier hs-var">blockInProgress</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset
</span><span class="hs-identifier hs-var">nextOffset</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679408126"><span class="hs-identifier hs-var">blockCreated</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#initialConsortiumState"><span class="hs-identifier hs-type">initialConsortiumState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span>
</span><span id="line-108"></span><span id="initialConsortiumState"><span class="annot"><span class="annottext">initialConsortiumState :: ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#initialConsortiumState"><span class="hs-identifier hs-var hs-var">initialConsortiumState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsortiumState :: Offset
-&gt; HashMap NodeId Int
-&gt; Maybe Byte
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type hs-type">ConsortiumState</span></a></span><span>
</span><span id="line-109"></span><span>                               </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:blockCreated:ConsortiumState :: Offset
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AblockCreated%3AConsortiumState"><span class="hs-identifier hs-var">blockCreated</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Offset
</span><span class="hs-identifier hs-var">firstOffset</span></span><span>
</span><span id="line-110"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:nodeIndexes:ConsortiumState :: HashMap NodeId Int
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeIndexes%3AConsortiumState"><span class="hs-identifier hs-var">nodeIndexes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap NodeId Int
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span>
</span><span id="line-111"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:nodeStates:ConsortiumState :: IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeStates%3AConsortiumState"><span class="hs-identifier hs-var">nodeStates</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
forall a. IntMap a
</span><span class="hs-identifier hs-var">IM.empty</span></span><span>
</span><span id="line-112"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:proposalSizeLimitMaybe:ConsortiumState :: Maybe Byte
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AproposalSizeLimitMaybe%3AConsortiumState"><span class="hs-identifier hs-var">proposalSizeLimitMaybe</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Byte
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">}</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span id="local-6989586621679408112"><span id="local-6989586621679408113"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#mapToNodeIdList"><span class="hs-identifier hs-type">mapToNodeIdList</span></a></span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679408113"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621679408112"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679408113"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679408112"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Logger</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408113"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408113"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#NodeIdsForBlock"><span class="hs-identifier hs-type">NodeIdsForBlock</span></a></span></span></span><span>
</span><span id="line-119"></span><span id="mapToNodeIdList"><span class="annot"><span class="annottext">mapToNodeIdList :: (r -&gt; (Logger, NodeId))
-&gt; SerialT m Event -&gt; SerialT m NodeIdsForBlock
</span><a href="Dolla.Consensus.Consortium.Projections.html#mapToNodeIdList"><span class="hs-identifier hs-var hs-var">mapToNodeIdList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsortiumState
-&gt; (r -&gt; (Logger, NodeId))
-&gt; SerialT m Event
-&gt; SerialT m NodeIdsForBlock
forall (m :: * -&gt; *) r.
(MonadIO m, MonadReader r m) =&gt;
ConsortiumState
-&gt; (r -&gt; (Logger, NodeId))
-&gt; SerialT m Event
-&gt; SerialT m NodeIdsForBlock
</span><a href="Dolla.Consensus.Consortium.Projections.html#toNodeIdList"><span class="hs-identifier hs-var">toNodeIdList</span></a></span><span> </span><span class="annot"><span class="annottext">ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#initialConsortiumState"><span class="hs-identifier hs-var">initialConsortiumState</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span id="local-6989586621679408264"><span id="local-6989586621679408265"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#toConsortiumState%27"><span class="hs-identifier hs-type">toConsortiumState'</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679408265"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-123"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621679408264"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679408265"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-124"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679408265"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679408264"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Logger</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408265"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.SerialT</span></span><span> </span><span class="annot"><a href="#local-6989586621679408265"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span></span></span><span>
</span><span id="line-128"></span><span id="toConsortiumState%27"><span class="annot"><span class="annottext">toConsortiumState' :: (r -&gt; (Logger, NodeId))
-&gt; SerialT m Event -&gt; SerialT m ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#toConsortiumState%27"><span class="hs-identifier hs-var hs-var">toConsortiumState'</span></a></span></span><span> </span><span id="local-6989586621679408110"><span class="annot"><span class="annottext">trans :: r -&gt; (Logger, NodeId)
</span><a href="#local-6989586621679408110"><span class="hs-identifier hs-var">trans</span></a></span></span><span> </span><span id="local-6989586621679408109"><span class="annot"><span class="annottext">events :: SerialT m Event
</span><a href="#local-6989586621679408109"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-129"></span><span>  </span><span id="local-6989586621679408108"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679408108"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SerialT m Event
</span><a href="#local-6989586621679408109"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679408107"><span class="annot"><span class="annottext">logger :: Logger
</span><a href="#local-6989586621679408107"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(r -&gt; (Logger, NodeId)) -&gt; SerialT m (Logger, NodeId)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">r -&gt; (Logger, NodeId)
</span><a href="#local-6989586621679408110"><span class="hs-identifier hs-var">trans</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="annottext">Logger -&gt; Priority -&gt; String -&gt; SerialT m ()
forall dependencies (m :: * -&gt; *).
(Loggable dependencies, MonadIO m) =&gt;
dependencies -&gt; Priority -&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">log</span></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621679408107"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><span class="hs-identifier hs-var">DEBUG</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SerialT m ()) -&gt; String -&gt; SerialT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;[projections] received event &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Event -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679408108"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679408108"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#BlockCreated"><span class="hs-identifier hs-type">BlockCreated</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:blockOffset:ConsortiumMembershipGranted :: Event -&gt; Offset
</span><a href="Dolla.Consensus.Consortium.Event.html#%24sel%3AblockOffset%3AConsortiumMembershipGranted"><span class="hs-identifier hs-var">blockOffset</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679408100"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679408100"><span class="hs-identifier hs-var">newBlockCreated</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-134"></span><span>      </span><span id="local-6989586621679408096"><span id="local-6989586621679408097"><span id="local-6989586621679408098"><span id="local-6989586621679408099"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SerialT m ConsortiumState
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-135"></span><span>      </span><span class="annot"><span class="annottext">Logger -&gt; Priority -&gt; String -&gt; SerialT m ()
forall dependencies (m :: * -&gt; *).
(Loggable dependencies, MonadIO m) =&gt;
dependencies -&gt; Priority -&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">log</span></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621679408107"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><span class="hs-identifier hs-var">DEBUG</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SerialT m ()) -&gt; String -&gt; SerialT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;[projections] new consortium state available from Block &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>  </span><span class="annot"><span class="annottext">Offset -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679408099"><span class="hs-identifier hs-var">blockCreated</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; to &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679408100"><span class="hs-identifier hs-var">newBlockCreated</span></a></span><span>
</span><span id="line-136"></span><span>      </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; SerialT m ()
forall (m :: * -&gt; *). Monad m =&gt; Offset -&gt; Offset -&gt; m ()
</span><span class="hs-identifier hs-var">verifyStrictlyMonotonicallyIncreasingOffsetPropertyOnM</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679408099"><span class="hs-identifier hs-var">blockCreated</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679408100"><span class="hs-identifier hs-var">newBlockCreated</span></a></span><span>
</span><span id="line-137"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679408093"><span class="annot"><span class="annottext">newState :: ConsortiumState
</span><a href="#local-6989586621679408093"><span class="hs-identifier hs-var hs-var">newState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsortiumState :: Offset
-&gt; HashMap NodeId Int
-&gt; Maybe Byte
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type hs-type">ConsortiumState</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:blockCreated:ConsortiumState :: Offset
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AblockCreated%3AConsortiumState"><span class="hs-identifier hs-var">blockCreated</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679408100"><span class="hs-identifier hs-var">newBlockCreated</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>      </span><span class="annot"><span class="annottext">ConsortiumState -&gt; SerialT m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="annot"><span class="annottext">ConsortiumState
</span><a href="#local-6989586621679408093"><span class="hs-identifier hs-var">newState</span></a></span><span>
</span><span id="line-139"></span><span>      </span><span class="annot"><span class="annottext">ConsortiumState -&gt; SerialT m ConsortiumState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ConsortiumState
</span><a href="#local-6989586621679408093"><span class="hs-identifier hs-var">newState</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#ProposalSizeLimited"><span class="hs-identifier hs-type">ProposalSizeLimited</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679408090"><span class="annot"><span class="annottext">Byte
$sel:size:ConsortiumMembershipGranted :: Event -&gt; Byte
size :: Byte
</span><a href="Dolla.Consensus.Consortium.Event.html#%24sel%3Asize%3AConsortiumMembershipGranted"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><span class="annottext">m () -&gt; SerialT m ConsortiumState
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) b a.
(IsStream t, Monad m) =&gt;
m b -&gt; t m a
</span><span class="hs-identifier hs-var">SIP.nilM</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; SerialT m ConsortiumState)
-&gt; m () -&gt; SerialT m ConsortiumState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="annottext">(ConsortiumState -&gt; ConsortiumState) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify'</span></span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679408083"><span id="local-6989586621679408084"><span id="local-6989586621679408085"><span id="local-6989586621679408086"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-144"></span><span>           </span><span class="annot"><span class="annottext">ConsortiumState :: Offset
-&gt; HashMap NodeId Int
-&gt; Maybe Byte
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type hs-type">ConsortiumState</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:proposalSizeLimitMaybe:ConsortiumState :: Maybe Byte
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AproposalSizeLimitMaybe%3AConsortiumState"><span class="hs-identifier hs-var">proposalSizeLimitMaybe</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Byte -&gt; Maybe Byte
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Byte
</span><a href="#local-6989586621679408090"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>    </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#ConsortiumMembershipGranted"><span class="hs-identifier hs-type">ConsortiumMembershipGranted</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679408081"><span class="annot"><span class="annottext">NodeId
$sel:nodeId:ConsortiumMembershipGranted :: Event -&gt; NodeId
nodeId :: NodeId
</span><a href="Dolla.Consensus.Consortium.Event.html#%24sel%3AnodeId%3AConsortiumMembershipGranted"><span class="hs-identifier hs-var hs-var">nodeId</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="annottext">m () -&gt; SerialT m ConsortiumState
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) b a.
(IsStream t, Monad m) =&gt;
m b -&gt; t m a
</span><span class="hs-identifier hs-var">SIP.nilM</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; SerialT m ConsortiumState)
-&gt; m () -&gt; SerialT m ConsortiumState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-147"></span><span>      </span><span class="annot"><span class="annottext">(ConsortiumState -&gt; ConsortiumState) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify'</span></span><span>
</span><span id="line-148"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679408076"><span id="local-6989586621679408077"><span id="local-6989586621679408078"><span id="local-6989586621679408079"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>           </span><span class="annot"><span class="annottext">ConsortiumState :: Offset
-&gt; HashMap NodeId Int
-&gt; Maybe Byte
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type hs-type">ConsortiumState</span></a></span><span>
</span><span id="line-150"></span><span>             </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:nodeIndexes:ConsortiumState :: HashMap NodeId Int
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeIndexes%3AConsortiumState"><span class="hs-identifier hs-var">nodeIndexes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeId -&gt; Int -&gt; HashMap NodeId Int -&gt; HashMap NodeId Int
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.insert</span></span><span> </span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679408081"><span class="hs-identifier hs-var">nodeId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap NodeId Int -&gt; Int
forall k v. HashMap k v -&gt; Int
</span><span class="hs-identifier hs-var">HM.size</span></span><span> </span><span class="annot"><span class="annottext">HashMap NodeId Int
</span><a href="#local-6989586621679408078"><span class="hs-identifier hs-var">nodeIndexes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap NodeId Int
</span><a href="#local-6989586621679408078"><span class="hs-identifier hs-var">nodeIndexes</span></a></span><span>
</span><span id="line-151"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:nodeStates:ConsortiumState :: IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeStates%3AConsortiumState"><span class="hs-identifier hs-var">nodeStates</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-152"></span><span>                 </span><span class="annot"><span class="annottext">Int
-&gt; (NodeId, MembershipStatus, LocationStatus)
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
forall a. Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">IM.insert</span></span><span>
</span><span id="line-153"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus) -&gt; Int
forall a. IntMap a -&gt; Int
</span><span class="hs-identifier hs-var">IM.size</span></span><span> </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408076"><span class="hs-identifier hs-var">nodeStates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679408081"><span class="hs-identifier hs-var">nodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MembershipStatus
</span><a href="Dolla.Consensus.Consortium.Projections.html#Granted"><span class="hs-identifier hs-var">Granted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LocationStatus
</span><a href="Dolla.Consensus.Consortium.Projections.html#NoLocation"><span class="hs-identifier hs-var">NoLocation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>                   </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408076"><span class="hs-identifier hs-var">nodeStates</span></a></span><span>
</span><span id="line-156"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span>
</span><span id="line-157"></span><span>             </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#ConsortiumMembershipRevoked"><span class="hs-identifier hs-type">ConsortiumMembershipRevoked</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679408070"><span class="annot"><span class="annottext">NodeId
nodeId :: NodeId
$sel:nodeId:ConsortiumMembershipGranted :: Event -&gt; NodeId
</span><a href="#local-6989586621679408070"><span class="hs-identifier hs-var hs-var">nodeId</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>      </span><span id="local-6989586621679408066"><span id="local-6989586621679408067"><span id="local-6989586621679408068"><span id="local-6989586621679408069"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SerialT m ConsortiumState
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-160"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679408065"><span class="annot"><span class="annottext">nodeIndexAsInt :: Int
</span><a href="#local-6989586621679408065"><span class="hs-identifier hs-var hs-var">nodeIndexAsInt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span>
</span><span id="line-162"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Int
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;toConsortiumState inconsistency : nodeId not present&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeId -&gt; HashMap NodeId Int -&gt; Maybe Int
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HM.lookup</span></span><span> </span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679408070"><span class="hs-identifier hs-var">nodeId</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap NodeId Int
</span><a href="#local-6989586621679408068"><span class="hs-identifier hs-var">nodeIndexes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679408061"><span class="annot"><span class="annottext">previousLocationStatus :: LocationStatus
</span><a href="#local-6989586621679408061"><span class="hs-identifier hs-var">previousLocationStatus</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>            </span><span class="annot"><span class="annottext">(NodeId, MembershipStatus, LocationStatus)
-&gt; Maybe (NodeId, MembershipStatus, LocationStatus)
-&gt; (NodeId, MembershipStatus, LocationStatus)
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span>
</span><span id="line-166"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; (NodeId, MembershipStatus, LocationStatus)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;toConsortiumState inconsistency : nodeIndex not present&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; Maybe (NodeId, MembershipStatus, LocationStatus)
forall a. Int -&gt; IntMap a -&gt; Maybe a
</span><span class="hs-identifier hs-var">IM.lookup</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679408065"><span class="hs-identifier hs-var">nodeIndexAsInt</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408066"><span class="hs-identifier hs-var">nodeStates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>         </span><span class="hs-comment">-- Changing the status of membership</span><span>
</span><span id="line-169"></span><span>      </span><span class="annot"><span class="annottext">m () -&gt; SerialT m ConsortiumState
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) b a.
(IsStream t, Monad m) =&gt;
m b -&gt; t m a
</span><span class="hs-identifier hs-var">SIP.nilM</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; SerialT m ConsortiumState)
-&gt; m () -&gt; SerialT m ConsortiumState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="annottext">ConsortiumState -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span>
</span><span id="line-171"></span><span>          </span><span class="annot"><span class="annottext">ConsortiumState :: Offset
-&gt; HashMap NodeId Int
-&gt; Maybe Byte
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type hs-type">ConsortiumState</span></a></span><span>
</span><span id="line-172"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HashMap NodeId Int
nodeIndexes :: HashMap NodeId Int
$sel:nodeIndexes:ConsortiumState :: HashMap NodeId Int
</span><a href="#local-6989586621679408068"><span class="hs-identifier hs-var hs-var">nodeIndexes</span></a></span><span>
</span><span id="line-173"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:nodeStates:ConsortiumState :: IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeStates%3AConsortiumState"><span class="hs-identifier hs-var">nodeStates</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>                </span><span class="annot"><span class="annottext">Int
-&gt; (NodeId, MembershipStatus, LocationStatus)
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
forall a. Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">IM.insert</span></span><span>
</span><span id="line-175"></span><span>                  </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679408065"><span class="hs-identifier hs-var">nodeIndexAsInt</span></a></span><span>
</span><span id="line-176"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679408070"><span class="hs-identifier hs-var">nodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MembershipStatus
</span><a href="Dolla.Consensus.Consortium.Projections.html#Revoked"><span class="hs-identifier hs-var">Revoked</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LocationStatus
</span><a href="#local-6989586621679408061"><span class="hs-identifier hs-var">previousLocationStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>                  </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408066"><span class="hs-identifier hs-var">nodeStates</span></a></span><span>
</span><span id="line-178"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span>
</span><span id="line-179"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-180"></span><span>    </span><span id="local-6989586621679408056"><span id="local-6989586621679408057"><span id="local-6989586621679408058"><span id="local-6989586621679408059"><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#TeamLocated"><span class="hs-identifier hs-type">TeamLocated</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679408050"><span class="annot"><span class="annottext">NodeId
nodeId :: NodeId
$sel:nodeId:ConsortiumMembershipGranted :: Event -&gt; NodeId
</span><a href="#local-6989586621679408050"><span class="hs-identifier hs-var hs-var">nodeId</span></a></span></span><span class="hs-special">,</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>      </span><span id="local-6989586621679408046"><span id="local-6989586621679408047"><span id="local-6989586621679408048"><span id="local-6989586621679408049"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SerialT m ConsortiumState
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679408045"><span class="annot"><span class="annottext">nodeIndexAsInt :: Int
</span><a href="#local-6989586621679408045"><span class="hs-identifier hs-var hs-var">nodeIndexAsInt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-183"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span>
</span><span id="line-184"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Int
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;toConsortiumState inconsistency : nodeId not present&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeId -&gt; HashMap NodeId Int -&gt; Maybe Int
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HM.lookup</span></span><span> </span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679408050"><span class="hs-identifier hs-var">nodeId</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap NodeId Int
</span><a href="#local-6989586621679408048"><span class="hs-identifier hs-var">nodeIndexes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679408044"><span class="annot"><span class="annottext">previousMembershipStatus :: MembershipStatus
</span><a href="#local-6989586621679408044"><span class="hs-identifier hs-var">previousMembershipStatus</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="annottext">(NodeId, MembershipStatus, LocationStatus)
-&gt; Maybe (NodeId, MembershipStatus, LocationStatus)
-&gt; (NodeId, MembershipStatus, LocationStatus)
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span>
</span><span id="line-188"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; (NodeId, MembershipStatus, LocationStatus)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;toConsortiumState inconsistency : nodeIndex not present&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; Maybe (NodeId, MembershipStatus, LocationStatus)
forall a. Int -&gt; IntMap a -&gt; Maybe a
</span><span class="hs-identifier hs-var">IM.lookup</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679408045"><span class="hs-identifier hs-var">nodeIndexAsInt</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408046"><span class="hs-identifier hs-var">nodeStates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>         </span><span class="hs-comment">-- updating Location</span><span>
</span><span id="line-191"></span><span>      </span><span class="annot"><span class="annottext">m () -&gt; SerialT m ConsortiumState
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) b a.
(IsStream t, Monad m) =&gt;
m b -&gt; t m a
</span><span class="hs-identifier hs-var">SIP.nilM</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; SerialT m ConsortiumState)
-&gt; m () -&gt; SerialT m ConsortiumState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><span class="annottext">ConsortiumState -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span>
</span><span id="line-193"></span><span>          </span><span class="annot"><span class="annottext">ConsortiumState :: Offset
-&gt; HashMap NodeId Int
-&gt; Maybe Byte
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type hs-type">ConsortiumState</span></a></span><span>
</span><span id="line-194"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HashMap NodeId Int
nodeIndexes :: HashMap NodeId Int
$sel:nodeIndexes:ConsortiumState :: HashMap NodeId Int
</span><a href="#local-6989586621679408048"><span class="hs-identifier hs-var hs-var">nodeIndexes</span></a></span><span>
</span><span id="line-195"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:nodeStates:ConsortiumState :: IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeStates%3AConsortiumState"><span class="hs-identifier hs-var">nodeStates</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-196"></span><span>                </span><span class="annot"><span class="annottext">Int
-&gt; (NodeId, MembershipStatus, LocationStatus)
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
forall a. Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">IM.insert</span></span><span>
</span><span id="line-197"></span><span>                  </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679408045"><span class="hs-identifier hs-var">nodeIndexAsInt</span></a></span><span>
</span><span id="line-198"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679408050"><span class="hs-identifier hs-var">nodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MembershipStatus
</span><a href="#local-6989586621679408044"><span class="hs-identifier hs-var">previousMembershipStatus</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Location -&gt; LocationStatus
</span><a href="Dolla.Consensus.Consortium.Projections.html#Located"><span class="hs-identifier hs-var">Located</span></a></span><span> </span><span class="annot"><span class="annottext">Location :: URL -&gt; URL -&gt; URL -&gt; URL -&gt; Location
</span><a href="Dolla.Consensus.Consortium.Projections.html#Location"><span class="hs-identifier hs-type hs-type">Location</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>                  </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408046"><span class="hs-identifier hs-var">nodeStates</span></a></span><span>
</span><span id="line-200"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span>
</span><span id="line-201"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-202"></span><span>    </span><span id="local-6989586621679408039"><span id="local-6989586621679408040"><span id="local-6989586621679408041"><span id="local-6989586621679408042"><span class="annot"><a href="Dolla.Consensus.Consortium.Event.html#TeamReLocated"><span class="hs-identifier hs-type">TeamReLocated</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679408037"><span class="annot"><span class="annottext">NodeId
nodeId :: NodeId
$sel:nodeId:ConsortiumMembershipGranted :: Event -&gt; NodeId
</span><a href="#local-6989586621679408037"><span class="hs-identifier hs-var hs-var">nodeId</span></a></span></span><span class="hs-special">,</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>      </span><span id="local-6989586621679408033"><span id="local-6989586621679408034"><span id="local-6989586621679408035"><span id="local-6989586621679408036"><span class="annot"><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type">ConsortiumState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SerialT m ConsortiumState
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679408032"><span class="annot"><span class="annottext">nodeIndexAsInt :: Int
</span><a href="#local-6989586621679408032"><span class="hs-identifier hs-var hs-var">nodeIndexAsInt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-205"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span>
</span><span id="line-206"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Int
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;toConsortiumState inconsistency : teamId not present&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeId -&gt; HashMap NodeId Int -&gt; Maybe Int
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HM.lookup</span></span><span> </span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679408037"><span class="hs-identifier hs-var">nodeId</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap NodeId Int
</span><a href="#local-6989586621679408035"><span class="hs-identifier hs-var">nodeIndexes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679408031"><span class="annot"><span class="annottext">previousMembershipStatus :: MembershipStatus
</span><a href="#local-6989586621679408031"><span class="hs-identifier hs-var">previousMembershipStatus</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-209"></span><span>            </span><span class="annot"><span class="annottext">(NodeId, MembershipStatus, LocationStatus)
-&gt; Maybe (NodeId, MembershipStatus, LocationStatus)
-&gt; (NodeId, MembershipStatus, LocationStatus)
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span>
</span><span id="line-210"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; (NodeId, MembershipStatus, LocationStatus)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;toConsortiumState inconsistency : nodeIndex not present&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; Maybe (NodeId, MembershipStatus, LocationStatus)
forall a. Int -&gt; IntMap a -&gt; Maybe a
</span><span class="hs-identifier hs-var">IM.lookup</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679408032"><span class="hs-identifier hs-var">nodeIndexAsInt</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408033"><span class="hs-identifier hs-var">nodeStates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>         </span><span class="hs-comment">-- updating Location</span><span>
</span><span id="line-213"></span><span>      </span><span class="annot"><span class="annottext">m () -&gt; SerialT m ConsortiumState
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) b a.
(IsStream t, Monad m) =&gt;
m b -&gt; t m a
</span><span class="hs-identifier hs-var">SIP.nilM</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; SerialT m ConsortiumState)
-&gt; m () -&gt; SerialT m ConsortiumState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-214"></span><span>        </span><span class="annot"><span class="annottext">ConsortiumState -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span>
</span><span id="line-215"></span><span>          </span><span class="annot"><span class="annottext">ConsortiumState :: Offset
-&gt; HashMap NodeId Int
-&gt; Maybe Byte
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; ConsortiumState
</span><a href="Dolla.Consensus.Consortium.Projections.html#ConsortiumState"><span class="hs-identifier hs-type hs-type">ConsortiumState</span></a></span><span>
</span><span id="line-216"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HashMap NodeId Int
nodeIndexes :: HashMap NodeId Int
$sel:nodeIndexes:ConsortiumState :: HashMap NodeId Int
</span><a href="#local-6989586621679408035"><span class="hs-identifier hs-var hs-var">nodeIndexes</span></a></span><span>
</span><span id="line-217"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:nodeStates:ConsortiumState :: IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="Dolla.Consensus.Consortium.Projections.html#%24sel%3AnodeStates%3AConsortiumState"><span class="hs-identifier hs-var">nodeStates</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-218"></span><span>                </span><span class="annot"><span class="annottext">Int
-&gt; (NodeId, MembershipStatus, LocationStatus)
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
-&gt; IntMap (NodeId, MembershipStatus, LocationStatus)
forall a. Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">IM.insert</span></span><span>
</span><span id="line-219"></span><span>                  </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679408032"><span class="hs-identifier hs-var">nodeIndexAsInt</span></a></span><span>
</span><span id="line-220"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679408037"><span class="hs-identifier hs-var">nodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MembershipStatus
</span><a href="#local-6989586621679408031"><span class="hs-identifier hs-var">previousMembershipStatus</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Location -&gt; LocationStatus
</span><a href="Dolla.Consensus.Consortium.Projections.html#Located"><span class="hs-identifier hs-var">Located</span></a></span><span> </span><span class="annot"><span class="annottext">Location :: URL -&gt; URL -&gt; URL -&gt; URL -&gt; Location
</span><a href="Dolla.Consensus.Consortium.Projections.html#Location"><span class="hs-identifier hs-type hs-type">Location</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>                  </span><span class="annot"><span class="annottext">IntMap (NodeId, MembershipStatus, LocationStatus)
</span><a href="#local-6989586621679408033"><span class="hs-identifier hs-var">nodeStates</span></a></span><span>
</span><span id="line-222"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span>
</span><span id="line-223"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-224"></span></pre></body></html>